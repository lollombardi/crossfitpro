<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CrossFit Pro - Cloud Cyber Edition</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            sendEmailVerification,
            sendPasswordResetEmail,
            updateEmail 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyASuX24x3WiK_LGtWqEfZM8btW1esVIX1Q",
            authDomain: "crossfitpro-2f642.firebaseapp.com",
            databaseURL: "https://crossfitpro-2f642-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "crossfitpro-2f642",
            storageBucket: "crossfitpro-2f642.firebasestorage.app",
            messagingSenderId: "14963097226",
            appId: "1:14963097226:web:18c6fa24a7e06eef857773",
            measurementId: "G-H3Q4NJEP53"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        window.auth = auth; 
        window.db = db;
        window.signIn = (e, p) => signInWithEmailAndPassword(auth, e, p);
        window.signUp = (e, p) => createUserWithEmailAndPassword(auth, e, p);
        window.logout = () => signOut(auth);
        window.verifyEmail = (user) => sendEmailVerification(user);
        window.resetPass = (email) => sendPasswordResetEmail(auth, email);

        window.dbRef = ref; window.dbSet = set; window.dbPush = push; window.dbOnValue = onValue; window.dbRemove = remove; window.dbGet = get;

        // GESTIONE ACCESSO E VERIFICA MAIL
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.emailVerified) {
                    currentUser = user;
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    document.getElementById('main-nav').style.display = 'none'; // Nascondo inizialmente per sicurezza
                    document.getElementById('main-nav').style.display = 'flex';
                    syncDates(new Date().toISOString().split('T')[0]);
                    populateExSelect();
                } else {
                    alert("ACCOUNT NON ATTIVO: Controlla la tua email e clicca sul link di verifica. Se non la trovi, controlla nello SPAM.");
                    signOut(auth);
                }
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('main-nav').style.display = 'none';
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff00ff;
            --neon-green: #00ff9f;
            --bg-black: #050505;
            --card-bg: rgba(20, 20, 25, 0.9);
            --text-main: #e0e0e0;
        }

        textarea { resize: none; overflow: hidden; min-height: 50px; width: 100%; box-sizing: border-box; display: block; }
        body { font-family: 'Orbitron', sans-serif; background: var(--bg-black); color: var(--text-main); margin: 0; padding-top: 90px; overflow-x: hidden; background-image: radial-gradient(circle at 50% 50%, rgba(0, 242, 255, 0.05) 0%, transparent 80%); }
        #login-overlay { 
            position: fixed; 
            top:0; left:0; 
            width:100%; 
            height:100%; 
            background: var(--bg-black); 
            z-index: 2000; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 0; /* Rimosso padding esterno */
            margin: 0;
        }

	.login-card { 
            background: var(--card-bg); 
            padding: 30px; 
            border: 1px solid var(--neon-blue); 
            box-shadow: 0 0 20px var(--neon-blue); 
            width: 85%; 
            max-width: 320px; 
            box-sizing: border-box;
	    width: 100%;
            box-sizing: border-box; /* Forza l'input a stare dentro la card */
            font-size: 16px; /* Evita lo zoom automatico di iOS quando clicchi sui campi */
        }

	.password-container {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }

        .login-card input {
            width: 100%;
            padding: 12px 45px 12px 12px; /* Aumentato padding destro per non sovrapporre testo e occhio */
            background: #000;
            border: 1px solid #333;
            color: #fff;
            box-sizing: border-box;
            font-family: 'Orbitron';
            font-size: 16px;
            height: 48px;
            display: block;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%; /* Met√† dell'altezza del contenitore */
            transform: translateY(-50%); /* Lo sposta indietro esattamente della met√† della sua altezza */
            cursor: pointer;
            color: #ffffff;
            font-size: 1.2em;
            z-index: 10;
            user-select: none;
            line-height: 0; /* Fondamentale: annulla l'altezza della riga del font */
            display: flex;
            align-items: center;
            justify-content: center;
        }

	#login-pass {
    	    padding-right: 45px;
	}

        /* Assicuriamoci che l'input lasci spazio all'icona a destra */
        #login-pass {
            padding-right: 45px;
        }
      
.navbar { position: fixed; top: 0; width: 100%; height: 75px; background: rgba(5, 5, 5, 0.95); border-bottom: 2px solid var(--neon-blue); display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { color: #666; font-size: 0.65em; cursor: pointer; text-align: center; text-transform: uppercase; font-weight: bold; }
        .nav-item.active { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }
        .container { max-width: 500px; margin: auto; padding: 0 20px; display: none; box-sizing: border-box; }
        .page { display: none; }
        .page.active { display: block; }
        /* Appiattisce e uniforma tutti i campi di inserimento */
        input, textarea, select { 
            width: 100% !important; 
            padding: 12px !important; 
            margin: 0 0 15px 0 !important; 
            background: #000 !important; 
            border: 1px solid #333 !important; 
            color: #fff !important; 
            box-sizing: border-box !important; /* Forza il calcolo della larghezza includendo il padding */
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            display: block;
            border-radius: 0; /* Rimuove arrotondamenti automatici su iPhone */
            -webkit-appearance: none; /* Rimuove lo stile predefinito Apple */
            appearance: none;
        }

        /* Correzione chirurgica per l'input data */
        input[type="date"] {
            min-height: 45px;
            line-height: 1.2;
            background-color: #000;
        }

        /* Per assicurarci che le card contengano tutto correttamente */
        .card {
            box-sizing: border-box !important;
            width: 100% !important;
            overflow: hidden; /* Impedisce a elementi interni di uscire */
        }
        .btn { width: 100%; padding: 16px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.3s; margin-bottom: 5px; }
        .btn-blue { background: #0055ff; color: white; }
        .btn-green { background: #00cc88; color: white; }
        .btn-red { background: #ff0055; color: white; }
        .whiteboard { background: #111; color: var(--neon-blue); padding: 15px; border: 1px solid var(--neon-blue); margin-bottom: 20px; font-size: 0.9em; white-space: pre-wrap; word-wrap: break-word; line-height: 1.4; }
        .log-entry { background: rgba(255,255,255,0.03); padding: 15px; margin-top: 10px; border: 1px solid #222; position: relative; }
        .btn-del { position: absolute; top: 10px; right: 10px; color: var(--neon-pink); background: none; border: none; cursor: pointer; font-weight: bold; }
        .tab-group { display: flex; background: #000; padding: 5px; margin-bottom: 20px; border: 1px solid #333; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #555; cursor: pointer; font-size: 0.75em; font-weight: bold; }
        .tab-btn.active.forza-style { color: white; border-bottom: 2px solid var(--neon-pink); background: rgba(255,0,255,0.1); }
        .tab-btn.active.wod-style { color: white; border-bottom: 2px solid var(--neon-blue); background: rgba(0,242,255,0.1); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2 style="color:var(--neon-blue); text-align:center; margin-bottom:20px;">ACCESSO</h2>
            
            <input type="email" id="login-email" placeholder="Email" autocomplete="email">
            
            <div class="password-container">
                <input type="password" id="login-pass" placeholder="Password">
                <span id="eye-icon" class="toggle-password" onclick="togglePasswordVisibility()">üëÅ</span>
            </div>
            
            <button class="btn btn-blue" onclick="handleLogin()">LOGIN</button>
            
            <div style="text-align:center; margin: 15px 0;">
                <span onclick="handleResetPassword()" style="color:var(--neon-blue); font-size:0.8em; cursor:pointer; text-decoration:underline; letter-spacing:1px;">
                    PASSWORD DIMENTICATA?
                </span>
            </div>

            <div style="border-top: 1px solid #333; margin-top: 20px; padding-top: 20px;">
                <button class="btn btn-green" style="font-size:0.75em;" onclick="handleSignUp()">REGISTRATI</button>
            </div>
            
            <p id="login-error" style="color:red; font-size:0.7em; margin-top:10px; text-align:center; min-height:1em;"></p>
        </div>
    </div>

    <nav class="navbar" id="main-nav" style="display:none;">
        <div class="nav-item active" onclick="showPage('plan-page', this)">üìã PROG.</div>
        <div class="nav-item" onclick="showPage('log-page', this)">üèãÔ∏è DIARIO</div>
        <div class="nav-item" onclick="showPage('meal-page', this)">üçé PASTI</div>
        <div class="nav-item" onclick="showPage('stats-page', this)">üìà STATS</div>
        <div class="nav-item" onclick="window.logout()">üö™ ESCI</div>
    </nav>

    <div class="container" id="app-container">
        <div id="plan-page" class="page active">
            <h2>üìã Lavagna</h2>
            <input type="date" id="datePlan" onchange="syncDates(this.value)">
            <div id="activePlanDisplay"></div>
            <div class="card">
                <textarea id="warmup" placeholder="Warm-up" oninput="autoResize(this)"></textarea>
                <textarea id="strength" placeholder="Forza / Skill" oninput="autoResize(this)"></textarea>
                <textarea id="gymnastics" placeholder="Ginnastica" oninput="autoResize(this)"></textarea>
                <textarea id="mainWod" placeholder="WOD" oninput="autoResize(this)"></textarea>
                <button class="btn btn-blue" onclick="savePlan()">Aggiorna Lavagna</button>
            </div>
        </div>
        <div id="log-page" class="page">
            <h2>üèãÔ∏è Diario Allenamento</h2>
            <input type="date" id="dateLog" onchange="syncDates(this.value)">
            <div class="tab-group">
                <button class="tab-btn active forza-style" onclick="switchInnerTab('inner-forza', this)">FORZA / SKILL</button>
                <button class="tab-btn wod-style" onclick="switchInnerTab('inner-wod', this)">SCORE WOD</button>
            </div>
            <div id="inner-forza" class="inner-tab"><div class="card"><select id="nameForza"><option value="">-- Seleziona Esercizio --</option>
                    <option value="Back squat (rack)">Back squat (rack)</option>
                    <option value="Clean and jerk">Clean and jerk</option>
                    <option value="Deadlift">Deadlift</option>
                    <option value="Front squat (da clean)">Front squat (da clean)</option>
                    <option value="Front squat (rack)">Front squat (rack)</option>
                    <option value="High hang clean">High hang clean</option>
                    <option value="High hang snatch">High hang snatch</option>
                    <option value="Low hang clean">Low hang clean</option>
                    <option value="Low hang snatch">Low hang snatch</option>
                    <option value="Overhead squat">Overhead squat</option>
                    <option value="Power clean">Power clean</option>
                    <option value="Power snatch">Power snatch</option>
                    <option value="Push jerk">Push jerk</option>
                    <option value="Push press">Push press</option>
                    <option value="Push press + Push jerk">Push press + Push jerk</option>
                    <option value="Split jerk">Split jerk</option>
                    <option value="Strict press">Strict press</option>
                    <option value="Strict press + Push jerk">Strict press + Push jerk</option>
                    <option value="Thruster">Thruster</option></select><input type="number" id="valForza" placeholder="Peso (kg)" inputmode="decimal"><textarea id="noteForza" placeholder="Note Forza..."></textarea><button class="btn btn-red" onclick="saveEntry('forza')">Salva Forza</button></div></div>
            <div id="inner-wod" class="inner-tab" style="display:none;"><div class="card" style="border-left-color: var(--neon-blue);"><input type="text" id="wodName" placeholder="Nome WOD"><input type="text" id="wodRes" placeholder="Risultato"><textarea id="wodNote" placeholder="Note WOD..."></textarea><button class="btn btn-blue" onclick="saveEntry('wod')">Salva WOD</button></div></div>
            <div id="historyDisplay"></div>
        </div>
        <div id="meal-page" class="page">
            <h2>üçé Diario Pasti</h2>
            <input type="date" id="dateMeal" onchange="syncDates(this.value)">
            <div class="card" style="border-left-color: var(--neon-green);"><input type="text" id="foodName" placeholder="Alimento"><div style="display:flex; gap:10px;"><input type="number" id="foodWeight" placeholder="Grammi"><input type="number" id="foodCal100" placeholder="Cal/100g"></div><button class="btn btn-green" onclick="addFoodLocal()">+ AGGIUNGI</button><div id="temp-meal-summary" style="margin-top:10px; font-size:0.8em; color:var(--neon-green);"></div><button class="btn btn-blue" onclick="saveMealCloud()">SALVA PASTO</button></div>
            <div id="mealsHistoryDisplay"></div>
        </div>
        <div id="stats-page" class="page">
            <h2>üìà Statistiche</h2>
            <div class="card"><select id="exSelect" onchange="initStatsListener()"></select><canvas id="statsChart"></canvas></div>
            <div class="card" style="border-left-color: var(--neon-pink);">
                <button class="btn btn-blue" onclick="exportCSV()">REPORT EXCEL (CSV)</button>
                <button class="btn btn-red" onclick="exportHTML()">REPORT STORICO (HTML)</button>
		<button class="btn" style="background: #ffcc00; color: black;" onclick="exportJSON()">REPORT JSON (BACKUP)</button>
            </div>
            <div class="card" style="border-left-color: #ff9900; margin-top: 20px;">
                <h3 style="color:#ff9900; font-size:0.8em; margin-top:0;">IMPORTA BACKUP JSON</h3>
                <input type="file" id="importJsonFile" accept=".json" style="font-size: 0.7em;">
                <button class="btn" style="background:#ff9900; color:white;" onclick="importJSON()">ESEGUI IMPORTAZIONE</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let tempItems = [];
        let myChart = null;

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        async function handleLogin() {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pass').value;
            try { await window.signIn(e, p); } catch(err) { document.getElementById('login-error').innerText = "Credenziali errate o account non verificato."; }
        }

        async function handleSignUp() {
            const e = document.getElementById('login-email').value.trim();
            const p = document.getElementById('login-pass').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(e)) { alert("Per favore, inserisci un indirizzo email valido."); return; }
            if (p.length < 6) { alert("La password deve avere almeno 6 caratteri."); return; }
            try { 
                const userCredential = await window.signUp(e, p);
                await window.verifyEmail(userCredential.user);
                alert("REGISTRAZIONE QUASI COMPLETATA: Ti abbiamo inviato una mail di verifica.");
                await window.logout();
            } catch(err) { document.getElementById('login-error').innerText = "Errore: " + err.message; }
        }

        async function handleResetPassword() {
            const email = document.getElementById('login-email').value;
            if (!email) { alert("Inserisci l'email nel campo sopra per ricevere il link di reset."); return; }
            try { await window.resetPass(email); alert("Email di reset inviata! Controlla la posta."); } catch (err) { alert("Errore: Email non trovata."); }
        }

	function togglePasswordVisibility() {
            const passInput = document.getElementById('login-pass');
            const eyeIcon = document.getElementById('eye-icon');
            
            if (passInput.type === 'password') {
                passInput.type = 'text';
                // Usiamo un simbolo sbarrato che ha lo stesso peso visivo
                eyeIcon.innerHTML = '‚äò'; 
                eyeIcon.style.color = 'var(--neon-blue)';
            } else {
                passInput.type = 'password';
                eyeIcon.innerHTML = 'üëÅ'; 
                eyeIcon.style.color = '#ffffff';
            }
        }

        async function importJSON() {
    const fileInput = document.getElementById('importJsonFile');
    if (!fileInput.files[0]) { alert("Seleziona prima un file .json"); return; }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async (e) => {
        try {
            const rawData = JSON.parse(e.target.result);
            let finalData = {};

            // Conversione HISTORY (da stringa a oggetto)
            if (rawData.cf_history) {
                const historyArray = JSON.parse(rawData.cf_history);
                finalData.history = {};
                historyArray.forEach((item, index) => {
                    // Creiamo una chiave univoca per ogni record
                    const newKey = "import_" + Date.now() + "_" + index;
                    finalData.history[newKey] = {
                        date: item.date,
                        name: item.name,
                        res: item.res.toString(),
                        note: item.note || "",
                        type: "forza" // Default per i dati importati
                    };
                });
            }

            // Conversione PLANS (da stringa a oggetto)
            if (rawData.cf_plans) {
                finalData.plans = JSON.parse(rawData.cf_plans);
            }

            if (confirm("Dati rilevati correttamente. Vuoi procedere con l'importazione sul tuo profilo cloud?")) {
                await window.dbSet(window.dbRef(window.db, `users/${currentUser.uid}`), finalData);
                alert("Importazione completata con successo!");
                window.location.reload();
            }
        } catch (err) { 
            console.error(err);
            alert("Errore durante la conversione del file: " + err.message); 
        }
    };
    reader.readAsText(file);
}

        function showPage(pId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(pId === 'stats-page') populateExSelect();
        }

        function syncDates(val) {
            document.getElementById('datePlan').value = val;
            document.getElementById('dateLog').value = val;
            document.getElementById('dateMeal').value = val;
            loadPlan(val); loadHistory(val); loadMeals(val);
        }

        function savePlan() {
            const date = document.getElementById('datePlan').value;
            const data = {
                w: document.getElementById('warmup').value,
                s: document.getElementById('strength').value,
                g: document.getElementById('gymnastics').value,
                m: document.getElementById('mainWod').value
            };
            window.dbSet(window.dbRef(window.db, `users/${currentUser.uid}/plans/${date}`), data);
        }

        function loadPlan(date) {
            window.dbOnValue(window.dbRef(window.db, `users/${currentUser.uid}/plans/${date}`), snap => {
                const p = snap.val();
                const div = document.getElementById('activePlanDisplay');
                const ids = ['warmup', 'strength', 'gymnastics', 'mainWod'];
                if(p) {
                    let visual = `<div class="whiteboard">`;
                    if(p.w) visual += `<small style="color:var(--neon-pink); font-size:0.7em; display:block; margin-bottom:2px;">WARM-UP</small>${p.w}\n\n`;
                    if(p.s) visual += `<small style="color:var(--neon-pink); font-size:0.7em; display:block; margin-bottom:2px;">FORZA / SKILL</small>${p.s}\n\n`;
                    if(p.g) visual += `<small style="color:var(--neon-pink); font-size:0.7em; display:block; margin-bottom:2px;">GINNASTICA</small>${p.g}\n\n`;
                    if(p.m) visual += `<small style="color:var(--neon-pink); font-size:0.7em; display:block; margin-bottom:2px;">WOD</small>${p.m}`;
                    visual += `</div>`;
                    div.innerHTML = visual;
                    document.getElementById('warmup').value = p.w || '';
                    document.getElementById('strength').value = p.s || '';
                    document.getElementById('gymnastics').value = p.g || '';
                    document.getElementById('mainWod').value = p.m || '';
                    setTimeout(() => { ids.forEach(id => { const el = document.getElementById(id); if(el) autoResize(el); }); }, 50);
                } else {
                    div.innerHTML = `<div style="text-align:center; padding:20px; color:#444; font-size:0.8em;">NESSUN PROGRAMMA</div>`;
                    ids.forEach(id => { const el = document.getElementById(id); if(el) { el.value = ""; el.style.height = '50px'; } });
                }
            });
        }

        function switchInnerTab(tabId, el) { document.querySelectorAll('.inner-tab').forEach(t => t.style.display = 'none'); document.getElementById(tabId).style.display = 'block'; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
        function saveEntry(type) { const date = document.getElementById('dateLog').value; let data = { date, type }; if(type === 'forza') { data.name = document.getElementById('nameForza').value; data.res = document.getElementById('valForza').value; data.note = document.getElementById('noteForza').value; } else { data.name = document.getElementById('wodName').value; data.res = document.getElementById('wodRes').value; data.note = document.getElementById('wodNote').value; } if(!data.name || !data.res) return; window.dbPush(window.dbRef(window.db, `users/${currentUser.uid}/history`), data); }
        function loadHistory(date) { window.dbOnValue(window.dbRef(window.db, `users/${currentUser.uid}/history`), snap => { const data = snap.val(); const display = document.getElementById('historyDisplay'); display.innerHTML = ""; if(data) { Object.keys(data).reverse().forEach(key => { const item = data[key]; if(item.date === date) { display.innerHTML += `<div class="log-entry" style="border-left-color:${item.type==='wod'?'#00f2ff':'#ff00ff'}"><button class="btn-del" onclick="deleteItem('history/${key}')">√ó</button><b>${item.name}</b>: ${item.res}<br><small>${item.note || ''}</small></div>`; } }); } }); }
        function addFoodLocal() { const n = document.getElementById('foodName').value, w = document.getElementById('foodWeight').value, c = document.getElementById('foodCal100').value; if(n && w && c) { tempItems.push({n, kcal: Math.round((w*c)/100)}); document.getElementById('temp-meal-summary').innerText = "In lista: " + tempItems.map(i => i.n).join(", "); document.getElementById('foodName').value = ""; document.getElementById('foodWeight').value = ""; } }
        function saveMealCloud() { const date = document.getElementById('dateMeal').value; const total = tempItems.reduce((s,x)=>s+x.kcal,0); if(total === 0) return; window.dbPush(window.dbRef(window.db, `users/${currentUser.uid}/meals`), { date, total, desc: tempItems.map(i => i.n).join(', ') }); tempItems = []; document.getElementById('temp-meal-summary').innerText = ""; }
        function loadMeals(date) { window.dbOnValue(window.dbRef(window.db, `users/${currentUser.uid}/meals`), snap => { const data = snap.val(); const display = document.getElementById('mealsHistoryDisplay'); display.innerHTML = ""; if(data) { Object.keys(data).reverse().forEach(key => { const item = data[key]; if(item.date === date) { display.innerHTML += `<div class="log-entry" style="border-left-color:var(--neon-green)"><button class="btn-del" onclick="deleteItem('meals/${key}')">√ó</button><b>Energia</b>: ${item.total} kcal<br><small>${item.desc}</small></div>`; } }); } }); }
        function populateExSelect() { window.dbOnValue(window.dbRef(window.db, `users/${currentUser.uid}/history`), snap => { const data = snap.val(); const sel = document.getElementById('exSelect'); if(!data) return; const names = [...new Set(Object.values(data).filter(x => x.type === 'forza' || !x.type).map(x => x.name))]; sel.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join(''); initStatsListener(); }, { onlyOnce: true }); }
        function initStatsListener() { const exName = document.getElementById('exSelect').value; window.dbOnValue(window.dbRef(window.db, `users/${currentUser.uid}/history`), snap => { const data = snap.val(); if(!data) return; const historyArr = Object.values(data).filter(i => i.name === exName).sort((a,b) => new Date(a.date)-new Date(b.date)); const labels = historyArr.map(i => i.date.split('-').reverse().join('/')); const values = historyArr.map(i => parseFloat(i.res)); if (myChart) myChart.destroy(); myChart = new Chart(document.getElementById('statsChart').getContext('2d'), { type:'line', data:{labels, datasets:[{label:exName, data:values, borderColor:'#00f2ff', tension:0.3}]}, options:{scales:{y:{grid:{color:'#222'},ticks:{color:'#888'}},x:{grid:{color:'#222'},ticks:{color:'#888'}}}} }); }); }
        window.deleteItem = (path) => { if(confirm("Eliminare?")) window.dbRemove(window.dbRef(window.db, `users/${currentUser.uid}/${path}`)); }
        async function exportCSV() { const snap = await window.dbGet(window.dbRef(window.db, `users/${currentUser.uid}/history`)); const data = snap.val(); if (!data) return; const history = Object.values(data); const csv = ["Data,Esercizio,Risultato,Note", ...history.map(e => `${e.date},"${e.name}",${e.res},"${(e.note || "")}"`)].join("\n"); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); link.download = `report.csv`; link.click(); }
        async function exportHTML() { const hSnap = await window.dbGet(window.dbRef(window.db, `users/${currentUser.uid}/history`)); const history = hSnap.val(); if (!history) return; let html = `<html><body style="background:#050505;color:#fff;"><h1>Report</h1>`; Object.values(history).forEach(h => { html += `<div style="border-left:4px solid #00f2ff;padding:10px;margin:10px;">${h.date} - ${h.name}: ${h.res}</div>`; }); html += `</body></html>`; const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([html], {type:'text/html'})); link.download = `report.html`; link.click(); }
	async function exportJSON() {
            try {
                const snap = await window.dbGet(window.dbRef(window.db, `users/${currentUser.uid}`));
                const data = snap.val();
                
                if (!data) {
                    alert("Nessun dato da esportare.");
                    return;
                }

                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `backup_cloud_cf_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            } catch (err) {
                alert("Errore durante l'esportazione: " + err.message);
            }
        }
    </script>
</body>
</html>
